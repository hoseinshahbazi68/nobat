<div class="page-container">
  <div class="page-header">
    <h1>ูพุฑููุงู ฺฉุงุฑุจุฑ</h1>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ...</p>
  </div>

  <div *ngIf="!isLoading" class="profile-content">
    <!-- User Info Card -->
    <div class="info-card">
      <div class="avatar-section">
        <div class="avatar-wrapper">
          <div class="avatar" [class.has-image]="true">
            <img [src]="getProfilePictureUrl()" alt="Profile Picture" class="avatar-image" (error)="onImageError($event)">
            <div class="avatar-overlay">
              <input type="file" id="profilePicture" accept="image/*" (change)="onFileSelected($event)"
                class="file-input-hidden">
              <label for="profilePicture" class="avatar-upload-label" title="ุงูุชุฎุงุจ ุนฺฉุณ ูพุฑููุงู">
                <span class="upload-icon">๐ท</span>
              </label>
              <button *ngIf="profilePictureUrl" type="button" class="btn-remove-avatar" (click)="removeProfilePicture()" title="ุญุฐู ุนฺฉุณ">
                โ
              </button>
            </div>
          </div>
          <label for="profilePicture" class="change-photo-link">
            <span>ุชุบุฑ ุนฺฉุณ</span>
          </label>
          <small class="avatar-hint" *ngIf="selectedFile">ุนฺฉุณ ุฌุฏุฏ ุงูุชุฎุงุจ ุดุฏู</small>
          <!-- Preview box for cropped image -->
          <div class="cropped-preview" *ngIf="selectedFile">
            <div class="preview-box">
              <img [src]="profilePictureUrl" alt="Preview" class="preview-image">
            </div>
            <small class="preview-label">ูพุดโููุงุด ุนฺฉุณ ฺฉุฑุงูพ ุดุฏู</small>
          </div>
        </div>
        <div class="user-info">
          <h2>{{ getFullName() || user?.nationalCode }}</h2>
          <p class="username">ฺฉุฏ ูู: {{ user?.nationalCode }}</p>
          <p class="roles">{{ getRoles() }}</p>
        </div>
      </div>
    </div>

    <!-- Profile Form Card -->
    <div class="form-card">
      <h3 class="card-title">ุงุทูุงุนุงุช ุดุฎุต</h3>
      <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">
        <div class="form-grid">
          <div class="form-group">
            <label for="nationalCode">ฺฉุฏ ูู</label>
            <input type="text" id="nationalCode" formControlName="nationalCode" readonly class="form-input readonly">
            <small class="form-hint">ฺฉุฏ ูู ูุงุจู ุชุบุฑ ูุณุช</small>
          </div>

          <div class="form-group">
            <label for="email">ุงูู <span class="required">*</span></label>
            <input type="email" id="email" formControlName="email" class="form-input"
              [class.invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
            <div *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched" class="error-message">
              <span *ngIf="profileForm.get('email')?.errors?.['required']">ูุทูุง ุงูู ุฑุง ูุงุฑุฏ ููุงุฏ</span>
              <span *ngIf="profileForm.get('email')?.errors?.['email']">ูุฑูุช ุงูู ุตุญุญ ูุณุช</span>
            </div>
          </div>

          <div class="form-group">
            <label for="firstName">ูุงู <span class="required">*</span></label>
            <input type="text" id="firstName" formControlName="firstName" class="form-input"
              [class.invalid]="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched">
            <div *ngIf="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched"
              class="error-message">
              ูุทูุง ูุงู ุฑุง ูุงุฑุฏ ููุงุฏ
            </div>
          </div>

          <div class="form-group">
            <label for="lastName">ูุงู ุฎุงููุงุฏฺฏ <span class="required">*</span></label>
            <input type="text" id="lastName" formControlName="lastName" class="form-input"
              [class.invalid]="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched">
            <div *ngIf="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched"
              class="error-message">
              ูุทูุง ูุงู ุฎุงููุงุฏฺฏ ุฑุง ูุงุฑุฏ ููุงุฏ
            </div>
          </div>

          <div class="form-group">
            <label for="phoneNumber">ุดูุงุฑู ุชููู</label>
            <input type="tel" id="phoneNumber" formControlName="phoneNumber" class="form-input"
              placeholder="09123456789">
          </div>

          <div class="form-group">
            <label for="cityId">ุดูุฑ</label>
            <div class="city-search-container">
              <input type="text" id="cityId" [(ngModel)]="citySearchText" [ngModelOptions]="{standalone: true}"
                (input)="onCitySearch()" (focus)="onCityInputFocus()" (blur)="onCityInputBlur()"
                placeholder="ุฌุณุชุฌู ู ุงูุชุฎุงุจ ุดูุฑ..." class="form-input city-search-input">
              <span class="search-icon">๐</span>
              <div class="city-dropdown" *ngIf="showCityDropdown && filteredCities.length > 0">
                <div class="city-item" *ngFor="let city of filteredCities" (click)="selectCity(city)">
                  <span class="city-name">{{ city.name }}</span>
                  <span class="province-name" *ngIf="city.provinceName">{{ city.provinceName }}</span>
                </div>
              </div>
              <div class="city-dropdown empty" *ngIf="showCityDropdown && filteredCities.length === 0">
                <div class="city-item">ุดูุฑ ุงูุช ูุดุฏ</div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="gender">ุฌูุณุช <span class="required">*</span></label>
            <select id="gender" formControlName="gender" class="form-input"
              [class.invalid]="profileForm.get('gender')?.invalid && profileForm.get('gender')?.touched">
              <option [value]="null">ุงูุชุฎุงุจ ฺฉูุฏ</option>
              <option *ngFor="let option of genderOptions" [value]="option.value">{{ option.label }}</option>
            </select>
            <div *ngIf="profileForm.get('gender')?.invalid && profileForm.get('gender')?.touched" class="error-message">
              ูุทูุง ุฌูุณุช ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
            </div>
          </div>

          <div class="form-group">
            <label for="birthDate">ุชุงุฑุฎ ุชููุฏ</label>
            <input type="date" id="birthDate" formControlName="birthDate" class="form-input">
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="isSaving || profileForm.invalid">
            <span *ngIf="!isSaving">๐พ ุฐุฎุฑู ุชุบุฑุงุช</span>
            <span *ngIf="isSaving">โณ ุฏุฑ ุญุงู ุฐุฎุฑู...</span>
          </button>
        </div>
      </form>
    </div>

  </div>
</div>
